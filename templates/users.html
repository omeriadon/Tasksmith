{% extends "base.html" %} {% block title %}Users - My Flask App{% endblock %} {%
block toolbar_title %}User Management{% endblock %} {% block content %}
<div class="max-w-4xl">
  <h1 class="text-3xl font-bold mb-6" style="color: rgb(var(--text-primary))">
    User Management
  </h1>

  <!-- Add User Form -->
  <div
    class="mb-8 p-6 rounded-lg border"
    style="
      background: rgb(var(--bg-secondary));
      border-color: rgb(var(--border-color));
    "
  >
    <h2
      class="text-xl font-semibold mb-4"
      style="color: rgb(var(--text-primary))"
    >
      Add New User
    </h2>
    <form id="addUserForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label
          class="block text-sm font-medium mb-2"
          style="color: rgb(var(--text-primary))"
        >
          Username
        </label>
        <input
          type="text"
          name="username"
          required
          class="w-full px-4 py-3 rounded-lg border outline-none transition-all duration-200"
          style="
            background: rgb(var(--bg-primary));
            border-color: rgb(var(--border-color));
            color: rgb(var(--text-primary));
          "
          placeholder="Enter username"
        />
      </div>
      <div>
        <label
          class="block text-sm font-medium mb-2"
          style="color: rgb(var(--text-primary))"
        >
          Email
        </label>
        <input
          type="email"
          name="email"
          required
          class="w-full px-4 py-3 rounded-lg border outline-none transition-all duration-200"
          style="
            background: rgb(var(--bg-primary));
            border-color: rgb(var(--border-color));
            color: rgb(var(--text-primary));
          "
          placeholder="Enter email"
        />
      </div>
      <div>
        <label
          class="block text-sm font-medium mb-2"
          style="color: rgb(var(--text-primary))"
        >
          Password
        </label>
        <input
          type="password"
          name="password"
          required
          class="w-full px-4 py-3 rounded-lg border outline-none transition-all duration-200"
          style="
            background: rgb(var(--bg-primary));
            border-color: rgb(var(--border-color));
            color: rgb(var(--text-primary));
          "
          placeholder="Enter password"
        />
      </div>
      <div class="md:col-span-3">
        <button
          type="submit"
          class="px-6 py-3 text-sm font-medium rounded-lg transition-all duration-200 text-white"
          style="background: rgb(var(--accent-blue))"
          onmouseover="this.style.background='rgb(var(--accent-blue-hover))'"
          onmouseout="this.style.background='rgb(var(--accent-blue))'"
        >
          Add User
        </button>
      </div>
    </form>
  </div>

  <!-- User List -->
  <div>
    <h2
      class="text-xl font-semibold mb-4"
      style="color: rgb(var(--text-primary))"
    >
      Existing Users
    </h2>
    <div id="userList" class="space-y-3">
      <div class="text-center py-8" style="color: rgb(var(--text-secondary))">
        <div class="flex flex-col items-center justify-center">
          <img
            src="/static/icons/progress.indicator.svg"
            alt="Loading"
            class="w-10 h-10 mb-2 animate-spin spinner"
          />
          <span>Loading users...</span>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  // USER MANAGEMENT
  async function loadUsers() {
    try {
      const result = await apiCall("/api/users");
      const userList = document.getElementById("userList");

      if (result.users && result.users.length > 0) {
        userList.innerHTML = result.users
          .map(
            (user) => `
          <div class="flex items-center justify-between p-4 rounded-lg border" 
               style="background: rgb(var(--bg-secondary)); border-color: rgb(var(--border-color))">
            <div>
              <div class="font-medium" style="color: rgb(var(--text-primary))">${
                user.username || user.email
              }</div>
              <div class="text-sm" style="color: rgb(var(--text-secondary))">${
                user.email
              }</div>
              <div class="text-xs" style="color: rgb(var(--text-tertiary))">ID: ${
                user.id
              }</div>
            </div>
            <div class="flex gap-2">
              <button onclick="editUser('${user.id}')" 
                      class="px-3 py-2 text-xs rounded-lg transition-all duration-200"
                      style="background: rgb(var(--accent-blue)); color: white">
                Edit
              </button>
              <button onclick="deleteUser('${user.id}')" 
                      class="px-3 py-2 text-xs rounded-lg transition-all duration-200"
                      style="background: #ff3b30; color: white">
                Delete
              </button>
            </div>
          </div>
        `
          )
          .join("");
      } else {
        userList.innerHTML =
          '<div class="text-center py-8" style="color: rgb(var(--text-secondary))">No users found</div>';
      }
    } catch (error) {
      const userList = document.getElementById("userList");
      userList.innerHTML =
        '<div class="text-center py-8" style="color: #ff3b30">Failed to load users. Check console for details.</div>';
      showMessage("Failed to load users: " + error.message, "error");
    }
  }

  async function addUser(formData) {
    try {
      const userData = {
        username: formData.get("username"),
        email: formData.get("email"),
        password: formData.get("password"),
      };

      const result = await apiCall("/api/users", "POST", userData);
      showMessage("User created successfully!");
      loadUsers();
      document.getElementById("addUserForm").reset();
    } catch (error) {
      showMessage("Failed to create user: " + error.message, "error");
    }
  }

  function editUser(userId) {
    const newUsername = prompt("Enter new username:");
    if (newUsername) {
      updateUser(userId, { username: newUsername });
    }
  }

  async function updateUser(userId, data) {
    try {
      await apiCall(`/api/users/${userId}`, "PUT", data);
      showMessage("User updated successfully!");
      loadUsers();
    } catch (error) {
      showMessage("Failed to update user: " + error.message, "error");
    }
  }

  async function deleteUser(userId) {
    if (confirm("Are you sure you want to delete this user?")) {
      try {
        await apiCall(`/api/users/${userId}`, "DELETE");
        showMessage("User deleted successfully!");
        loadUsers();
      } catch (error) {
        showMessage("Failed to delete user: " + error.message, "error");
      }
    }
  }

  // Form submission handler
  document
    .getElementById("addUserForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      addUser(formData);
    });

  // Load users on page load
  window.addEventListener("load", function () {
    // Wait for auth check to complete before loading users
    setTimeout(() => {
      if (isAuthenticated) {
        loadUsers();
      }
    }, 100);
  });
</script>
{% endblock %}
